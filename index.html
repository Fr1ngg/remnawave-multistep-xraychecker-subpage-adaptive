<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <link rel="apple-touch-icon" sizes="180x180" href="/assets/apple-touch-icon-180x180.png" />
    <link rel="icon" type="image/png" sizes="32x32" href="/assets/favicon-32x32.png" />
    <link rel="icon" type="image/png" sizes="16x16" href="/assets/favicon-16x16.png" />
    <link rel="icon" type="image/x-icon" href="/assets/favicon.ico" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#3b82f6" id="themeColor">
    <meta name="description" content="<%= metaDescription %>" />
    <title><%= metaTitle %></title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script type="module" defer>
        import { polyfillCountryFlagEmojis } from "https://cdn.skypack.dev/country-flag-emoji-polyfill";
        polyfillCountryFlagEmojis();
    </script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode-generator@1.4.4/qrcode.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');

        :root {
            --primary: #3b82f6;
            --primary-dark: #2563eb;
            --background: #f8fafc;
            --surface: #ffffff;
            --surface-strong: #e2e8f0;
            --text-primary: #0f172a;
            --text-secondary: #475569;
            --border: #e2e8f0;
            --shadow: 0 20px 45px -20px rgba(15, 23, 42, 0.25);
        }

        .dark-theme {
            --background: #0f172a;
            --surface: #1e293b;
            --surface-strong: #334155;
            --text-primary: #e2e8f0;
            --text-secondary: #94a3b8;
            --border: #1f2937;
            --shadow: 0 20px 45px -20px rgba(15, 23, 42, 0.6);
        }

        *, *::before, *::after { box-sizing: border-box; }

        body {
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
            margin: 0;
            min-height: 100vh;
            background: var(--background);
            color: var(--text-primary);
            transition: background 0.3s ease, color 0.3s ease;
        }

        .container {
            max-width: 960px;
            margin: 0 auto;
            padding: 24px 16px 48px;
            display: flex;
            flex-direction: column;
            gap: 24px;
        }

        .header {
            display: flex;
            flex-direction: column;
            gap: 12px;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 20px;
            padding: 20px 24px;
            box-shadow: var(--shadow);
        }

        .header-top {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 16px;
        }

        .logo {
            font-weight: 700;
            font-size: 1.5rem;
            display: flex;
            align-items: center;
            gap: 12px;
            color: var(--text-primary);
        }

        .controls {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            border-radius: 12px;
            border: 1px solid transparent;
            padding: 10px 16px;
            font-weight: 500;
            font-size: 0.95rem;
            cursor: pointer;
            transition: transform 0.15s ease, box-shadow 0.15s ease, background 0.15s ease;
            background: var(--surface-strong);
            color: var(--text-primary);
        }

        .btn:hover { transform: translateY(-1px); }

        .btn-primary {
            background: var(--primary);
            color: #ffffff;
        }

        .btn-primary:hover { background: var(--primary-dark); }

        .btn-icon {
            padding: 10px 12px;
        }

        .btn-icon svg { width: 20px; height: 20px; }

        main {
            display: flex;
            flex-direction: column;
            gap: 24px;
        }

        .card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 20px;
            padding: 24px;
            box-shadow: var(--shadow);
        }

        .card-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
            margin-bottom: 20px;
        }

        .card-title {
            font-size: 1.2rem;
            font-weight: 600;
        }

        .info-row {
            display: flex;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid var(--border);
            font-size: 0.95rem;
        }

        .info-row:last-child { border-bottom: none; }

        .info-label { color: var(--text-secondary); }

        .info-value { font-weight: 600; }

        .badge {
            padding: 4px 10px;
            border-radius: 999px;
            font-weight: 600;
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .badge-active { background: rgba(16, 185, 129, 0.15); color: #047857; }
        .badge-disabled { background: rgba(248, 113, 113, 0.15); color: #b91c1c; }
        .badge-limited { background: rgba(251, 191, 36, 0.2); color: #b45309; }
        .badge-expired { background: rgba(148, 163, 184, 0.2); color: #475569; }

        .links-section .link-item {
            display: flex;
            flex-direction: column;
            gap: 12px;
            padding: 16px;
            border-radius: 16px;
            border: 1px solid var(--border);
            margin-bottom: 12px;
            background: rgba(148, 163, 184, 0.08);
        }

        .link-item:last-child { margin-bottom: 0; }

        .link-name { font-weight: 600; word-break: break-word; }

        .link-actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .apps-section .platform-tabs {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 20px;
        }

        .platform-tab {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            border-radius: 999px;
            padding: 8px 16px;
            border: 1px solid var(--border);
            cursor: pointer;
            transition: background 0.15s ease;
        }

        .platform-tab.active {
            background: var(--primary);
            color: #fff;
            border-color: transparent;
        }

        .apps-container { display: flex; flex-direction: column; gap: 16px; }

        .featured-apps-row, .apps-grid {
            display: grid;
            gap: 16px;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        }

        .app-card {
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 16px;
            background: rgba(148, 163, 184, 0.08);
            cursor: pointer;
            transition: transform 0.15s ease, box-shadow 0.15s ease;
        }

        .app-card:hover { transform: translateY(-2px); box-shadow: var(--shadow); }

        .app-header { display: flex; align-items: center; gap: 12px; }

        .app-icon svg { width: 32px; height: 32px; }

        .featured-badge {
            align-self: flex-start;
            padding: 4px 10px;
            border-radius: 999px;
            background: rgba(59, 130, 246, 0.15);
            color: var(--primary);
            font-size: 0.75rem;
            font-weight: 600;
        }

        .spoiler-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: pointer;
            padding: 12px 16px;
            border-radius: 12px;
            border: 1px solid var(--border);
            background: rgba(148, 163, 184, 0.08);
        }

        .spoiler-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }

        .spoiler-content.open { max-height: 1000px; padding-top: 12px; }

        .modal {
            position: fixed;
            inset: 0;
            background: rgba(15, 23, 42, 0.55);
            display: none;
            align-items: center;
            justify-content: center;
            padding: 24px;
            z-index: 1000;
        }

        .modal.active { display: flex; }

        .modal-content {
            width: min(540px, 100%);
            max-height: 90vh;
            overflow-y: auto;
            background: var(--surface);
            border-radius: 20px;
            padding: 24px;
            border: 1px solid var(--border);
            box-shadow: var(--shadow);
            position: relative;
        }

        .modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
            margin-bottom: 16px;
        }

        .modal-close {
            border: none;
            background: transparent;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-secondary);
        }

        .step {
            display: flex;
            flex-direction: column;
            gap: 12px;
            padding: 16px;
            border-radius: 16px;
            border: 1px solid var(--border);
            background: rgba(148, 163, 184, 0.08);
            margin-bottom: 16px;
        }

        .step:last-child { margin-bottom: 0; }

        .step-number {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: var(--primary);
            color: #fff;
            font-weight: 600;
            margin-right: 8px;
        }

        .step-title { font-weight: 600; display: flex; align-items: center; gap: 8px; }

        .step-buttons { display: flex; flex-wrap: wrap; gap: 8px; }

        .qr-container { display: flex; flex-direction: column; align-items: center; gap: 12px; }

        .toast {
            position: fixed;
            bottom: 24px;
            right: 24px;
            background: var(--text-primary);
            color: var(--surface);
            padding: 12px 16px;
            border-radius: 12px;
            opacity: 0;
            transform: translateY(8px);
            transition: opacity 0.3s ease, transform 0.3s ease;
            z-index: 1100;
        }

        .toast.show { opacity: 1; transform: translateY(0); }

        .footer {
            text-align: center;
            color: var(--text-secondary);
            padding-bottom: 24px;
        }

        @media (max-width: 600px) {
            .header { padding: 16px; }
            .controls { flex-wrap: wrap; justify-content: flex-end; }
            .card { padding: 20px; }
            .modal { padding: 16px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <div class="header-top">
                <div class="logo"><%= metaTitle %></div>
                <div class="controls">
                    <button class="btn btn-icon" onclick="openModal('settingsModal')">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.049 2.927c.3-1.14 1.603-1.14 1.902 0a1.724 1.724 0 002.573 1.066c1.024-.593 2.15.532 1.557 1.556a1.724 1.724 0 001.066 2.573c1.14.3 1.14 1.603 0 1.902a1.724 1.724 0 00-1.066 2.573c.593 1.024-.532 2.15-1.556 1.557a1.724 1.724 0 00-2.574 1.066c-.3 1.14-1.603 1.14-1.902 0a1.724 1.724 0 00-2.573-1.066c-1.024.593-2.15-.532-1.557-1.556a1.724 1.724 0 00-1.066-2.574c-1.14-.3-1.14-1.602 0-1.901a1.724 1.724 0 001.066-2.574c-.593-1.024.532-2.15 1.556-1.557.966.56 2.18.198 2.574-1.066z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
                        <span class="btn-text" data-key="settings">Settings</span>
                    </button>
                    <button class="btn btn-primary btn-icon" onclick="showSubscriptionModal()">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.102m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"/></svg>
                        <span class="btn-text" data-key="get_link">Get Link</span>
                    </button>
                </div>
            </div>
            <div class="subtitle" data-key="page_subtitle"><%= metaDescription %></div>
        </header>

        <main id="mainContent"></main>

        <footer class="footer"><%= metaDescription %></footer>
    </div>

    <div class="modal" id="settingsModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" data-key="settings">Settings</h3>
                <button class="modal-close" onclick="closeModal('settingsModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="step">
                    <div class="step-title" data-key="theme">Theme</div>
                    <div class="step-buttons">
                        <button class="btn" onclick="setTheme('light')" data-key="light">Light</button>
                        <button class="btn" onclick="setTheme('dark')" data-key="dark">Dark</button>
                        <button class="btn" onclick="setTheme('auto')" data-key="auto">Auto</button>
                    </div>
                </div>
                <div class="step">
                    <div class="step-title" data-key="language">Language</div>
                    <div class="step-buttons" id="languageButtons"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal" id="qrModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="qrModalTitle" data-key="qr_code">QR Code</h3>
                <button class="modal-close" onclick="closeModal('qrModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="qr-container">
                    <div id="qrCode"></div>
                    <p data-key="scan_with_phone">Scan with your phone</p>
                </div>
            </div>
        </div>
    </div>

    <div class="modal" id="platformModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" data-key="select_platform">Select Platform</h3>
                <button class="modal-close" onclick="closeModal('platformModal')">&times;</button>
            </div>
            <div class="modal-body" id="platformModalBody"></div>
        </div>
    </div>

    <div class="modal" id="appModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="appModalTitle"></h3>
                <button class="modal-close" onclick="closeModal('appModal')">&times;</button>
            </div>
            <div class="modal-body" id="appModalBody"></div>
        </div>
    </div>

    <div class="modal" id="subscriptionModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" data-key="subscription_link">Subscription Link</h3>
                <button class="modal-close" onclick="closeModal('subscriptionModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="qr-container">
                    <div id="subscriptionQrCode"></div>
                    <p data-key="scan_with_phone">Scan with your phone</p>
                </div>
                <div class="step-buttons" style="justify-content: center; display: flex;">
                    <button class="btn btn-primary" onclick="copySubscriptionUrl()">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"/></svg>
                        <span data-key="copy">Copy</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="toast" id="toast"></div>

    <script>
        let panelData = null;
        let appsConfig = null;
        let currentLanguage = 'en';
        let currentPlatform = 'android';
        let toastTimeout = null;
        let validPlatforms = [];
        let branding = null;

        const langFullNames = {
            en: 'English',
            ru: 'Русский',
            fa: 'فارسی',
            zh: '中文',
            tr: 'Türkçe',
            uz: 'Oʻzbekcha'
        };

        const appIcons = {
            happ: `<svg class="w-6 h-6" viewBox="0 0 32 32" fill="currentColor"><path d="M13.4 19.6l-7.9 7.9L5 30.4h6.6l1.8-10.8z"/><path d="M13.2 13.5L14.6 5l-7.9 7.9L4.2 27.4l7.9-7.9.2-1.2h1l4.9-4.9h-5.2z"/><path d="M25.4 19.6L27.8 5l-7.9 7.9-.1.7h-.6l-4.9 4.9h4.7l-1.5 9 7.9-7.9z"/><path d="M18.7 27.5l-.5 2.9h6.6l1.8-10.8-7.9 7.9z"/><path d="M13.6 4.9l.6-3.3H7.5L5.6 12.8l8-7.9z"/><path d="M18.8 12.8l7.9-7.9.6-3.3h-6.6l-1.9 11.2z"/></svg>`,
            'sing-box': `<svg class="w-6 h-6" viewBox="0 0 32 32" fill="currentColor"><path d="M28.845 22.699c.608-.37.998-1.235 1-1.854V11.2s.008-.403-.417-.673L16.825 2.649s-1.48-.95-2.921 0L2.407 10.324c-.536.37-.558 1.036-.558 1.036l-.004 9.339s-.013 1.171.5 1.5l12.5 8 .048-11-12.158-7.694s-.556-.351.158-.76L14.345 3.2c1.032-.628 2.06-.03 2.06-.03l12.556 7.687c.604.254.158.444.158.444l-2.849 1.805s-.404.357-.888.112L12.356 5.134l-.48.316 13.47 8.249v3.5a.93.93 0 0 1-.362.745l-3.777 2.515s-.348.25-.362-.26v-3.5L7.43 8.359l-.542.369 13.036 8.158s.384.207-.056.446l-3.32 1.982v9.885s-.002.637-.702 1c0 0 .521.128 1.467-.432z"/></svg>`,
            shadowrocket: `<svg class="w-6 h-6" viewBox="0 0 32 32" fill="currentColor"><path d="M26.76 23.819 20.1 22.658c-.837 1.628-2.32 2.309-4.238 2.302-1.91-.007-3.417-.646-4.3-2.344-2.183.385-4.39.77-6.734 1.182.061-.817.084-1.587.19-2.35.26-1.835 1.081-3.443 2.512-4.79.25-.233.357-.48.335-.845-.19-3.113.182-6.157 1.521-9.05a14.638 14.638 0 0 1 4.513-5.6c.51-.385 1.057-.729 1.628-1.017.205-.103.601-.083.807.027 1.3.742 2.473 1.65 3.424 2.728 1.118 1.265 2.031 2.667 2.678 4.192 1.164 2.763 1.59 5.614 1.4 8.549-.03.432.084.762.434 1.099 1.81 1.711 2.519 3.82 2.541 6.143.268.008.543.016.811.007.014-.008.028-.069.124zm-1.827-1.814c.038-.103.053-.13.053-.158a.815.815 0 0 0 0-.193c-.114-1.903-.844-3.56-2.374-4.906-.16-.138-.327-.364-.32-.543.115-1.828.19-3.656-.38-5.442-.32-1.004-.548-2.041-.99-2.997-.958-2.075-2.312-3.91-4.397-5.229-.624-.399-.685-.399-1.294.028-2.58 1.786-4.185 4.157-5.068 6.947-.654 2.089-.814 4.22-.639 6.377.03.371-.091.625-.388.873-.867.707-1.46 1.587-1.856 2.577a7.172 7.172 0 0 0-.518 2.597l5.73-1.024c.122.227.22.433.335.626.631 1.044 1.598 1.642 2.93 1.683 1.377.041 2.396-.522 3.104-1.58.434-.653.434-.653 1.278-.502.038.007.069.014.107.02l4.687.846zM15.802 34c-1.126-1.546-2.222-3.03-2.55-4.824-.243-1.326.617-2.604 1.941-3.058.898-.31 1.918.02 2.587.81.624.743.822 1.595.632 2.482-.373 1.718-1.415 3.147-2.61 4.59zm-.099-2.24c.107 0 .213 0 .312-.007.342-.756.715-1.498 1.027-2.268.229-.563.023-1.1-.327-1.58-.373-.523-1.05-.57-1.545-.138-.449.392-.7.9-.525 1.43.297.865.7 1.704 1.058 2.563z"/><path d="M15.772 7.647c1.955-.048 3.477 1.374 3.485 2.996.007 1.738-1.492 3.12-3.387 3.127-1.894.006-3.332-1.327-3.393-3.058-.054-1.498 1.575-3.148 3.295-3.065zm1.94 3.106c-.005-1.0-.804-1.776-1.832-1.79-1.065-.014-2.009.742-1.994 1.724.015.949.822 1.698 1.865 1.711 1.103.007 1.925-.7 1.94-1.683z"/></svg>`,
            v2rayng: `<svg class="w-6 h-6" viewBox="0 0 32 32" fill="currentColor"><path d="M0 1.863v1.863h1.878h1.878l.05 13.637.075 13.637L18.402 15.699C26.389 7.303 32.974.323 33 .199c.05-.099-2.153-.199-4.882-.199h-4.957l-6.885 6.384-6.885 6.309-.153-6.309-.105-6.309-4.557-.074L0 0v1.863z"/></svg>`,
            'clash-meta': `<svg class="w-6 h-6" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2a10 10 0 1 0 10 10A10.011 10.011 0 0 0 12 2zm0 18a8 8 0 1 1 8-8 8.009 8.009 0 0 1-8 8zm3.59-10.59L11 14l-2.59-2.59L7 12.82l4 4 6-6z"/></svg>`,
            'clash-verge': `<svg class="w-6 h-6" viewBox="0 0 24 24" fill="currentColor"><path d="M3 4h18v2H3zm2 4h14v2H5zm-2 4h18v2H3zm2 4h14v2H5z"/></svg>`,
            flclash: `<svg class="w-6 h-6" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2l7 7h-4v6h-6V9H5z"/><path d="M5 18h14v2H5z"/></svg>`,
            flclashx: `<svg class="w-6 h-6" viewBox="0 0 24 24" fill="currentColor"><path d="M4 4h16v2H4zm2 4h12v2H6zm-2 4h16v2H4zm2 4h12v2H6z"/></svg>`,
            android: `<svg class="w-6 h-6" viewBox="0 0 24 24" fill="currentColor"><path d="M6 18c0 .55.45 1 1 1h1v3.5c0 .83.67 1.5 1.5 1.5s1.5-.67 1.5-1.5V19h2v3.5c0 .83.67 1.5 1.5 1.5s1.5-.67 1.5-1.5V19h1c.55 0 1-.45 1-1V8H6v10zM3.5 8C2.67 8 2 8.67 2 9.5v7c0 .83.67 1.5 1.5 1.5S5 17.33 5 16.5v-7C5 8.67 4.33 8 3.5 8zM20.5 8C19.67 8 19 8.67 19 9.5v7c0 .83.67 1.5 1.5 1.5s1.5-.67 1.5-1.5v-7c0-.83-.67-1.5-1.5-1.5zM15.53 2.16l1.3-1.3a.5.5 0 00-.71-.71l-1.48 1.48A6.5 6.5 0 0012 1c-.96 0-1.86.23-2.66.63L7.85.15a.5.5 0 00-.71.71l1.31 1.31C6.97 3.26 6 5.01 6 7h12c0-1.99-.97-3.75-2.47-4.84zM10 5H9V4h1v1zm5 0h-1V4h1v1z"/></svg>`,
            ios: `<svg class="w-6 h-6" viewBox="0 0 24 24" fill="currentColor"><path d="M18.71 19.5c-.83 1.24-1.71 2.45-3.05 2.47-1.34.03-1.77-.79-3.29-.79-1.53 0-2 .77-3.28.82-1.3.05-2.29-1.32-3.13-2.53C4.25 17 2.94 12.45 4.7 9.39c.87-1.52 2.43-2.48 4.12-2.51 1.28-.02 2.5.87 3.29.87.78 0 2.26-1.07 3.81-.91 1.16.07 2.98.3 4.15 2.02-.09.06-2.17 1.28-2.15 3.81.03 3.02 2.65 4.03 2.68 4.04-.03.07-.42 1.44-1.38 2.83M13 3.5c.73-.83 1.94-1.46 2.94-1.5.13 1.17-.34 2.35-1.04 3.19-.69.85-1.83 1.51-2.95 1.42-.15-1.15.41-2.35 1.05-3.11z"/></svg>`,
            macos: `<svg class="w-6 h-6" viewBox="0 0 24 24" fill="currentColor"><path d="M20 18V6c0-1.1-.9-2-2-2H6C4.9 4 4 4.9 4 6v12c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2z"/></svg>`,
            windows: `<svg class="w-6 h-6" viewBox="0 0 24 24" fill="currentColor"><path d="M3 5.51l8-1.14v8.34H3m9-9.72l9-1.3v11.34h-9M3 12.51h8v8.34l-8-1.14m9 1.3v-8.5h9v7.2"/></svg>`,
            linux: `<svg class="w-6 h-6" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2a3 3 0 013 3v1h.5A2.5 2.5 0 0118 8.5V9a3 3 0 01-1 2.24V16a4 4 0 01-4 4h-2a4 4 0 01-4-4v-4.76A3 3 0 016 9v-.5A2.5 2.5 0 018.5 6H9V5a3 3 0 013-3z"/></svg>`
        };
        const translations = {
            en: {
                settings: 'Settings',
                get_link: 'Get Link',
                theme: 'Theme',
                language: 'Language',
                light: 'Light',
                dark: 'Dark',
                auto: 'Auto',
                qr_code: 'QR Code',
                scan_with_phone: 'Scan with your phone',
                select_platform: 'Select Platform',
                subscription_link: 'Subscription Link',
                copy: 'Copy',
                copied: 'Copied!',
                no_data: 'No data available',
                username: 'Username',
                status: 'Status',
                expires_at: 'Expires',
                days_left: 'Days left',
                traffic_used: 'Traffic used',
                traffic_reset: 'Traffic reset',
                unlimited: 'Unlimited',
                never_expires: 'Never expires',
                ACTIVE: 'Active',
                DISABLED: 'Disabled',
                LIMITED: 'Limited',
                EXPIRED: 'Expired',
                NO_RESET: 'No reset',
                DAY: 'Daily',
                WEEK: 'Weekly',
                MONTH: 'Monthly',
                HOUR: 'Hourly',
                subscription_links: 'Subscription servers',
                get_subscription: 'Get subscription',
                available_apps: 'Available applications',
                other_apps: 'More applications',
                featured: 'Recommended',
                install_app: 'Install app',
                add_subscription: 'Add subscription',
                connect_use: 'Connect & use',
                additional_step: 'Additional step',
                step: 'Step',
                support: 'Support',
                ios: 'iOS',
                android: 'Android',
                macos: 'macOS',
                windows: 'Windows',
                linux: 'Linux',
                copy_success: 'Link copied',
                page_subtitle: 'Your VPN subscription details',
                profile: 'Profile'
            },
            ru: {
                settings: 'Настройки',
                get_link: 'Получить ссылку',
                theme: 'Тема',
                language: 'Язык',
                light: 'Светлая',
                dark: 'Тёмная',
                auto: 'Авто',
                qr_code: 'QR-код',
                scan_with_phone: 'Отсканируйте телефоном',
                select_platform: 'Выберите платформу',
                subscription_link: 'Ссылка подписки',
                copy: 'Копировать',
                copied: 'Скопировано!',
                no_data: 'Данные не найдены',
                username: 'Пользователь',
                status: 'Статус',
                expires_at: 'Истекает',
                days_left: 'Дней осталось',
                traffic_used: 'Использовано',
                traffic_reset: 'Сброс трафика',
                unlimited: 'Безлимит',
                never_expires: 'Бессрочно',
                ACTIVE: 'Активен',
                DISABLED: 'Отключён',
                LIMITED: 'Ограничен',
                EXPIRED: 'Истёк',
                NO_RESET: 'Без сброса',
                DAY: 'Каждый день',
                WEEK: 'Каждую неделю',
                MONTH: 'Каждый месяц',
                HOUR: 'Каждый час',
                subscription_links: 'Доступные серверы',
                get_subscription: 'Получить подписку',
                available_apps: 'Доступные приложения',
                other_apps: 'Другие приложения',
                featured: 'Рекомендуем',
                install_app: 'Установить',
                add_subscription: 'Добавить подписку',
                connect_use: 'Подключиться',
                additional_step: 'Дополнительный шаг',
                step: 'Шаг',
                support: 'Поддержка',
                ios: 'iOS',
                android: 'Android',
                macos: 'macOS',
                windows: 'Windows',
                linux: 'Linux',
                copy_success: 'Ссылка скопирована',
                page_subtitle: 'Данные вашей VPN-подписки',
                profile: 'Профиль'
            },
            fa: {
                settings: 'تنظیمات',
                get_link: 'دریافت لینک',
                theme: 'پوسته',
                language: 'زبان',
                light: 'روشن',
                dark: 'تیره',
                auto: 'خودکار',
                qr_code: 'کد QR',
                scan_with_phone: 'با تلفن خود اسکن کنید',
                select_platform: 'انتخاب پلتفرم',
                subscription_link: 'لینک اشتراک',
                copy: 'کپی',
                copied: 'کپی شد!',
                no_data: 'اطلاعاتی یافت نشد',
                username: 'نام کاربری',
                status: 'وضعیت',
                expires_at: 'تاریخ انقضا',
                days_left: 'روز باقی‌مانده',
                traffic_used: 'ترافیک مصرف شده',
                traffic_reset: 'بازه بازنشانی',
                unlimited: 'نامحدود',
                never_expires: 'بدون انقضا',
                ACTIVE: 'فعال',
                DISABLED: 'غیرفعال',
                LIMITED: 'محدود',
                EXPIRED: 'منقضی شده',
                NO_RESET: 'بدون بازنشانی',
                DAY: 'روزانه',
                WEEK: 'هفتگی',
                MONTH: 'ماهانه',
                HOUR: 'ساعتی',
                subscription_links: 'سرورهای اشتراک',
                get_subscription: 'دریافت اشتراک',
                available_apps: 'برنامه‌های موجود',
                other_apps: 'برنامه‌های دیگر',
                featured: 'پیشنهادی',
                install_app: 'نصب برنامه',
                add_subscription: 'افزودن اشتراک',
                connect_use: 'اتصال و استفاده',
                additional_step: 'مرحله اضافی',
                step: 'مرحله',
                support: 'پشتیبانی',
                ios: 'iOS',
                android: 'اندروید',
                macos: 'macOS',
                windows: 'ویندوز',
                linux: 'لینوکس',
                copy_success: 'لینک کپی شد',
                page_subtitle: 'جزئیات اشتراک VPN شما',
                profile: 'پروفایل'
            }
        };

        document.addEventListener('DOMContentLoaded', initializeApp);
        function initializeApp() {
            loadSettings();
            loadAppsConfig();
            loadPanelData();
        }

        function loadSettings() {
            const savedTheme = localStorage.getItem('theme') || 'auto';
            applyTheme(savedTheme);
            const savedLang = localStorage.getItem('lang') || getBrowserLanguage();
            setLanguage(savedLang);
        }

        function getBrowserLanguage() {
            const lang = (navigator.language || navigator.userLanguage || 'en').slice(0, 2);
            return translations[lang] ? lang : 'en';
        }

        function setTheme(theme) {
            localStorage.setItem('theme', theme);
            applyTheme(theme);
        }

        function applyTheme(theme) {
            const html = document.documentElement;
            const meta = document.getElementById('themeColor');
            let isDark = false;
            if (theme === 'auto') {
                isDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            } else {
                isDark = theme === 'dark';
            }
            html.classList.toggle('dark-theme', isDark);
            meta.setAttribute('content', isDark ? '#0f172a' : '#3b82f6');
        }

        function setLanguage(lang) {
            currentLanguage = translations[lang] ? lang : 'en';
            localStorage.setItem('lang', currentLanguage);
            updateTexts();
            if (panelData?.response?.isFound) {
                renderContent();
            }
        }

        function setupLanguageButtons() {
            const container = document.getElementById('languageButtons');
            container.innerHTML = '';
            const baseLangs = ['en'];
            const additionalLangs = appsConfig?.config?.additionalLocales || [];
            const allLangs = [...new Set([...baseLangs, ...additionalLangs])];
            allLangs.forEach(code => {
                if (!langFullNames[code]) return;
                const button = document.createElement('button');
                button.className = 'btn';
                button.textContent = langFullNames[code];
                button.onclick = () => setLanguage(code);
                container.appendChild(button);
            });
        }

        function updateTexts() {
            document.querySelectorAll('[data-key]').forEach(el => {
                const key = el.getAttribute('data-key');
                const text = t(key);
                if (text) {
                    el.textContent = text;
                }
            });
        }

        function t(key) {
            return translations[currentLanguage]?.[key] || translations.en[key] || key;
        }

        function detectOS() {
            const ua = navigator.userAgent;
            const platform = navigator.platform;
            if (/iPad|iPhone|iPod/.test(ua) && !window.MSStream) return 'ios';
            if (/Android/.test(ua)) return 'android';
            if (/Mac/.test(platform)) return 'macos';
            if (/Win/.test(platform)) return 'windows';
            if (/Linux/.test(platform)) return 'linux';
            return 'windows';
        }

        function fetchAppConfig() {
            return fetch('/assets/app-config.json').catch(() => fetch('/app-config.json'));
        }

        function loadAppsConfig() {
            fetchAppConfig()
                .then(response => {
                    if (!response || !response.ok) {
                        return Promise.reject(new Error(`Failed to load app config: ${response?.status}`));
                    }
                    return response.json();
                })
                .then(data => {
                    appsConfig = data;
                    branding = data.config?.branding || null;
                    if (data.platforms) {
                        validPlatforms = Object.keys(data.platforms).filter(p => Array.isArray(data.platforms[p]) && data.platforms[p].length);
                    } else {
                        validPlatforms = Object.keys(data).filter(p => Array.isArray(data[p]) && data[p].length);
                        appsConfig = { platforms: data };
                    }
                    setupLanguageButtons();
                    updateBranding();
                })
                .catch(error => console.error('Error loading apps config:', error))
                .finally(() => {
                    if (panelData) {
                        renderContent();
                    }
                });
        }
        function updateBranding() {
            if (!branding) return;
            const logo = document.querySelector('.logo');
            if (branding.logoUrl && logo && !logo.querySelector('.brand-logo')) {
                const img = document.createElement('img');
                img.src = branding.logoUrl;
                img.alt = branding.name || 'Logo';
                img.className = 'brand-logo';
                img.style.cssText = 'height:32px;width:auto;border-radius:6px;';
                logo.insertBefore(img, logo.firstChild);
            }
            if (branding.supportUrl) {
                const controls = document.querySelector('.controls');
                if (controls && !controls.querySelector('.support-btn')) {
                    const btn = document.createElement('button');
                    btn.className = 'btn btn-icon support-btn';
                    btn.onclick = () => openLink(branding.supportUrl);
                    const isTelegram = branding.supportUrl.startsWith('https://t.me');
                    btn.innerHTML = isTelegram
                        ? `<svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24"><path d="M11.944 0A12 12 0 0 0 0 12a12 12 0 0 0 12 12 12 12 0 0 0 12-12A12 12 0 0 0 12 0a12 12 0 0 0-.056 0zm4.962 7.224c.1-.002.321.023.465.14a.506.506 0 0 1 .171.325c.016.093.036.306.02.472-.18 1.898-.962 6.502-1.36 8.627-.168.9-.499 1.201-.82 1.23-.696.065-1.225-.46-1.9-.902-1.056-.693-1.653-1.124-2.678-1.8-1.185-.78-.417-1.21.258-1.91.177-.184 3.247-2.977 3.307-3.23.007-.032.014-.15-.056-.212s-.174-.041-.249-.024c-.106.024-1.793 1.14-5.061 3.345-.48.33-.913.49-1.302.48-.428-.008-1.252-.241-1.865-.44-.752-.245-1.349-.374-1.297-.789.027-.216.325-.437.893-.663 3.498-1.524 5.83-2.529 6.998-3.014 3.332-1.386 4.025-1.627 4.476-1.635z"/></svg>`
                        : `<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>`;
                    btn.insertAdjacentHTML('beforeend', `<span class="btn-text" data-key="support">${t('support')}</span>`);
                    const settingsBtn = controls.querySelector('button');
                    controls.insertBefore(btn, settingsBtn);
                }
            }
            updateTexts();
        }

        function loadPanelData() {
            const encoded = '<%= panelData %>';
            if (!encoded) {
                panelData = { response: { isFound: false } };
                renderContent();
                return;
            }
            try {
                panelData = JSON.parse(atob(encoded));
            } catch (error) {
                console.error('Error decoding panel data:', error);
                panelData = { response: { isFound: false } };
            }
            if (appsConfig !== null) {
                renderContent();
            }
        }

        function renderContent() {
            const main = document.getElementById('mainContent');
            if (!panelData?.response?.isFound) {
                main.innerHTML = `<div class="card"><div data-key="no_data">${t('no_data')}</div></div>`;
                updateTexts();
                return;
            }
            const userInfo = renderUserInfo();
            const appsSection = renderAppsSection();
            const linksSection = renderLinksSection();
            main.innerHTML = `${userInfo}${appsSection}${linksSection}`;
            updateTexts();
            updateBranding();
            attachEventListeners();
        }
        function renderUserInfo() {
            const user = panelData.response.user;
            if (!user) return '';
            const expiresDate = user.expiresAt ? new Date(user.expiresAt) : null;
            const isNeverExpires = expiresDate && expiresDate.getFullYear() >= 2099;
            const isActive = (user.userStatus || '').toLowerCase() === 'active';
            const trafficLimit = user.trafficLimit === '0' ? t('unlimited') : escapeHtml(user.trafficLimit || '—');
            return `
                <section class="card user-info">
                    <div class="card-header">
                        <h2 class="card-title" data-key="profile">${t('profile')}</h2>
                    </div>
                    <div class="card-content">
                        <div class="info-row">
                            <span class="info-label" data-key="username">${t('username')}</span>
                            <span class="info-value">${escapeHtml(user.username || '—')}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label" data-key="status">${t('status')}</span>
                            <span class="badge badge-${(user.userStatus || '').toLowerCase()}">${t(user.userStatus)}</span>
                        </div>
                        ${isActive ? `
                            <div class="info-row">
                                <span class="info-label" data-key="expires_at">${t('expires_at')}</span>
                                <span class="info-value">${isNeverExpires ? t('never_expires') : formatDate(expiresDate)}</span>
                            </div>
                            ${!isNeverExpires && user.daysLeft ? `<div class="info-row"><span class="info-label" data-key="days_left">${t('days_left')}</span><span class="info-value">${escapeHtml(String(user.daysLeft))}</span></div>` : ''}
                            <div class="info-row">
                                <span class="info-label" data-key="traffic_used">${t('traffic_used')}</span>
                                <span class="info-value">${escapeHtml(user.trafficUsed || '0')} / ${trafficLimit}</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label" data-key="traffic_reset">${t('traffic_reset')}</span>
                                <span class="info-value">${t(user.trafficLimitStrategy)}</span>
                            </div>
                        ` : ''}
                    </div>
                </section>
            `;
        }

        function renderLinksSection() {
            const links = collectSubscriptionLinks();
            if (!links.length) return '';
            return `
                <section class="card links-section">
                    <div class="card-header">
                        <h2 class="card-title" data-key="subscription_links">${t('subscription_links')}</h2>
                    </div>
                    <div class="card-content">
                        ${links.map(link => `
                            <div class="link-item">
                                <div class="link-info">
                                    <div class="link-name">${escapeHtml(extractLinkName(link))}</div>
                                </div>
                                <div class="link-actions">
                                    <button class="btn btn-sm copy-btn" data-copy-text="${escapeAttribute(link)}">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"/></svg>
                                        <span data-key="copy">${t('copy')}</span>
                                    </button>
                                    <button class="btn btn-sm qr-btn" data-qr-text="${escapeAttribute(link)}" data-qr-title="${escapeAttribute(extractLinkName(link))}">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 5h4v4H5V5zm10 0h4v4h-4V5zM5 15h4v4H5v-4zm10-4h4v4h-4v-4z"/></svg>
                                        <span data-key="qr_code">${t('qr_code')}</span>
                                    </button>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </section>
            `;
        }

        function collectSubscriptionLinks() {
            const response = panelData?.response;
            if (!response) return [];
            const seen = new Set();
            const addLinks = list => {
                if (!list) return;
                list.forEach(link => {
                    if (typeof link === 'string' && link.trim() && !seen.has(link)) {
                        seen.add(link);
                    }
                });
            };
            if (Array.isArray(response.links)) {
                addLinks(response.links);
            }
            if (response.ssConfLinks) {
                Object.values(response.ssConfLinks).forEach(entry => {
                    if (Array.isArray(entry)) {
                        addLinks(entry);
                    } else if (entry && Array.isArray(entry.links)) {
                        addLinks(entry.links);
                    }
                });
            }
            if (Array.isArray(response.subscriptionLinks)) {
                addLinks(response.subscriptionLinks);
            }
            if (response.subscriptionUrl) {
                addLinks([response.subscriptionUrl]);
            }
            return Array.from(seen);
        }
        function renderAppsSection() {
            const platforms = appsConfig?.platforms;
            if (!platforms || validPlatforms.length === 0) return '';
            const stored = localStorage.getItem('platform');
            currentPlatform = validPlatforms.includes(stored) ? stored : detectOS();
            if (!validPlatforms.includes(currentPlatform)) {
                currentPlatform = validPlatforms[0];
            }
            return `
                <section class="card apps-section">
                    <div class="card-header">
                        <h2 class="card-title" data-key="available_apps">${t('available_apps')}</h2>
                        <button class="btn" id="platform-selector-btn" onclick="openPlatformModal()">
                            ${getAppIcon({ id: currentPlatform }, currentPlatform)} <span>${t(currentPlatform)}</span>
                        </button>
                    </div>
                    <div class="card-content">
                        <div class="platform-tabs">
                            ${validPlatforms.map(p => `<div class="platform-tab ${p === currentPlatform ? 'active' : ''}" data-platform="${p}">${getAppIcon({ id: p }, p)} ${t(p)}</div>`).join('')}
                        </div>
                        <div id="appsGrid">${renderAppsForPlatform()}</div>
                    </div>
                </section>
            `;
        }

        function renderAppsForPlatform() {
            const apps = appsConfig.platforms[currentPlatform] || [];
            const featuredApps = apps.filter(app => app.isFeatured);
            const otherApps = apps.filter(app => !app.isFeatured);
            let html = '<div class="apps-container">';
            if (featuredApps.length) {
                html += `<div class="featured-apps-row">${featuredApps.map(renderAppCard).join('')}</div>`;
            }
            if (otherApps.length) {
                html += `
                    <div class="other-apps-spoiler">
                        <div class="spoiler-header">
                            <span data-key="other_apps">${t('other_apps')}</span>
                            <svg class="w-4 h-4 spoiler-arrow" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
                        </div>
                        <div class="spoiler-content">
                            <div class="apps-grid">${otherApps.map(renderAppCard).join('')}</div>
                        </div>
                    </div>
                `;
            }
            html += '</div>';
            return html;
        }

        function renderAppCard(app) {
            return `
                <div class="app-card ${app.isFeatured ? 'featured' : ''}" data-app-id="${escapeAttribute(app.id)}">
                    ${app.isFeatured ? `<div class="featured-badge" data-key="featured">${t('featured')}</div>` : ''}
                    <div class="app-header">
                        <div class="app-icon">${getAppIcon(app, currentPlatform)}</div>
                        <div class="app-name">${escapeHtml(app.name)}</div>
                    </div>
                    <div class="btn btn-primary" style="width:100%;justify-content:center;" data-key="install_app">${t('install_app')}</div>
                </div>
            `;
        }

        function getAppIcon(app, platform) {
            const appId = app.id?.toLowerCase();
            if (appIcons[appId]) return appIcons[appId];
            if (appId?.includes('flclashx')) return appIcons['flclashx'];
            if (appId?.includes('flclash')) return appIcons['flclash'];
            if (appId?.includes('clash-verge')) return appIcons['clash-verge'];
            if (appId?.includes('clash')) return appIcons['clash-meta'];
            if (appId?.includes('v2ray')) return appIcons['v2rayng'];
            return appIcons[platform] || appIcons['windows'];
        }
        function renderAppSteps(app) {
            const response = panelData?.response;
            if (!response) return '<div class="step"><div class="step-description">No data available</div></div>';
            const stepData = {
                subscriptionUrl: response.subscriptionUrl,
                cryptoLink: response.happ?.cryptoLink || response.cryptoLink
            };
            let stepsHtml = '';
            let stepCounter = 1;
            if (app.installationStep) {
                stepsHtml += renderStep(app.installationStep, 'installationStep', app, stepData, stepCounter++);
            }
            if (app.additionalBeforeAddSubscriptionStep) {
                stepsHtml += renderStep(app.additionalBeforeAddSubscriptionStep, 'additionalBeforeAddSubscriptionStep', app, stepData, stepCounter++);
            }
            if (app.addSubscriptionStep) {
                stepsHtml += renderStep(app.addSubscriptionStep, 'addSubscriptionStep', app, stepData, stepCounter++);
            }
            if (app.additionalAfterAddSubscriptionStep) {
                stepsHtml += renderStep(app.additionalAfterAddSubscriptionStep, 'additionalAfterAddSubscriptionStep', app, stepData, stepCounter++);
            }
            if (app.connectAndUseStep) {
                stepsHtml += renderStep(app.connectAndUseStep, 'connectAndUseStep', app, stepData, stepCounter++);
            }
            return stepsHtml || '<div class="step"><div class="step-description">No setup steps available</div></div>';
        }

        function getStepNumber(stepKey, stepNumber) {
            return stepNumber ? stepNumber.toString() : '1';
        }

        function getStepTitle(stepKey, stepConfig) {
            if (stepKey === 'additionalBeforeAddSubscriptionStep' || stepKey === 'additionalAfterAddSubscriptionStep') {
                if (stepConfig?.title) {
                    if (typeof stepConfig.title === 'object') {
                        return stepConfig.title[currentLanguage] || stepConfig.title.en || t('additional_step');
                    }
                    return stepConfig.title;
                }
                return t('additional_step');
            }
            const titles = {
                installationStep: t('install_app'),
                addSubscriptionStep: t('add_subscription'),
                connectAndUseStep: t('connect_use')
            };
            return titles[stepKey] || t('step');
        }

        function renderStep(stepConfig, stepKey, app, data, stepNumber) {
            if (!stepConfig) return '';
            const stepNum = getStepNumber(stepKey, stepNumber);
            const stepTitle = getStepTitle(stepKey, stepConfig);
            let buttonsHtml = '';
            if (stepConfig.buttons) {
                buttonsHtml = stepConfig.buttons.map(button => {
                    const buttonText = typeof button.buttonText === 'object'
                        ? (button.buttonText[currentLanguage] || button.buttonText.en || 'Open')
                        : button.buttonText || 'Open';
                    return `<button class="btn btn-primary" onclick="openLink('${escapeAttribute(button.buttonLink)}')">${escapeHtml(buttonText)}</button>`;
                }).join('');
            }
            if (stepKey === 'addSubscriptionStep') {
                const finalUrl = buildSubscriptionUrl(app, data);
                if (finalUrl) {
                    buttonsHtml += `<button class="btn btn-primary" onclick="openSubscriptionUrl('${escapeAttribute(finalUrl)}')">${t('add_subscription')}</button>`;
                }
            }
            const description = getLocalizedText(stepConfig.description);
            return `
                <div class="step">
                    <div class="step-title">
                        <span class="step-number">${stepNum}</span>
                        ${stepTitle}
                    </div>
                    <div class="step-description">${escapeHtml(description)}</div>
                    <div class="step-buttons">${buttonsHtml}</div>
                </div>
            `;
        }

        function getLocalizedText(textObj) {
            if (!textObj) return '';
            if (typeof textObj === 'string') return textObj;
            return textObj[currentLanguage] || textObj.en || '';
        }
        function buildSubscriptionUrl(app, data) {
            if (!app) return '';
            const isInTelegram = !!window.Telegram?.WebApp?.initData;
            const REDIRECT_BASE = 'https://legiz-ru.github.io/Orion/redirect-page/?redirect_to=';
            if (app.id === 'happ') {
                const happLink = data.cryptoLink;
                if (!happLink) return '';
                if (isInTelegram) {
                    const prefix = app.redirectLink && app.redirectLink.trim() ? app.redirectLink : REDIRECT_BASE;
                    return prefix + encodeURIComponent(happLink);
                }
                return happLink;
            }
            if (!app.urlScheme || !data.subscriptionUrl) return '';
            let subscriptionPart = data.subscriptionUrl;
            if (app.isNeedBase64Encoding) {
                try {
                    subscriptionPart = btoa(subscriptionPart);
                } catch (error) {
                    console.error('Base64 encoding failed:', error);
                    return '';
                }
            }
            const targetUrl = app.urlScheme + subscriptionPart;
            if (isInTelegram) {
                const prefix = app.redirectLink && app.redirectLink.trim() ? app.redirectLink : REDIRECT_BASE;
                return prefix + encodeURIComponent(targetUrl);
            }
            return targetUrl;
        }

        function openLink(url) {
            try {
                if (window.Telegram?.WebApp) {
                    window.Telegram.WebApp.openLink(url);
                } else {
                    window.open(url, '_blank');
                }
            } catch (error) {
                console.error('Failed to open URL:', error);
                window.open(url, '_blank');
            }
        }

        function openSubscriptionUrl(url) {
            if (!url || url === '#') {
                console.warn('Invalid subscription URL:', url);
                return;
            }
            try {
                if (window.Telegram?.WebApp?.initData) {
                    window.Telegram.WebApp.openLink(url);
                } else {
                    window.open(url, '_blank');
                }
            } catch (error) {
                console.error('Failed to open subscription URL:', error);
                if (window.prompt) {
                    prompt('Copy this link:', url);
                }
            }
        }

        function openPlatformModal() {
            const modalBody = document.getElementById('platformModalBody');
            modalBody.innerHTML = `<div class="platform-modal-list">
                ${validPlatforms.map(p => `
                    <div class="platform-modal-item" data-platform="${p}">
                        ${getAppIcon({ id: p }, p)}
                        <span>${t(p)}</span>
                    </div>
                `).join('')}
            </div>`;
            modalBody.querySelectorAll('.platform-modal-item').forEach(item => {
                item.addEventListener('click', e => {
                    const platform = e.currentTarget.dataset.platform;
                    switchPlatform(platform);
                    closeModal('platformModal');
                });
            });
            openModal('platformModal');
        }
        function switchPlatform(platform) {
            if (!platform || platform === currentPlatform) return;
            currentPlatform = platform;
            localStorage.setItem('platform', platform);
            document.querySelectorAll('.platform-tab').forEach(tab => {
                tab.classList.toggle('active', tab.dataset.platform === platform);
            });
            const appsGrid = document.getElementById('appsGrid');
            appsGrid.innerHTML = renderAppsForPlatform();
            const button = document.getElementById('platform-selector-btn');
            if (button) {
                button.innerHTML = `${getAppIcon({ id: platform }, platform)} <span>${t(platform)}</span>`;
            }
            updateTexts();
            attachAppCardListeners(appsGrid);
            attachSpoilerListeners(appsGrid);
        }

        function throttle(func, limit) {
            let inThrottle;
            return function(...args) {
                if (!inThrottle) {
                    func.apply(this, args);
                    inThrottle = true;
                    setTimeout(() => (inThrottle = false), limit);
                }
            };
        }

        const throttledSwitchPlatform = throttle(switchPlatform, 200);

        function attachEventListeners() {
            document.querySelectorAll('.platform-tab').forEach(tab => {
                tab.addEventListener('click', e => {
                    const platform = e.currentTarget.dataset.platform;
                    if (platform) throttledSwitchPlatform(platform);
                });
            });
            attachAppCardListeners(document);
            attachSpoilerListeners(document);
            document.querySelectorAll('.copy-btn').forEach(btn => {
                btn.addEventListener('click', e => copyToClipboard(e.currentTarget.dataset.copyText));
            });
            document.querySelectorAll('.qr-btn').forEach(btn => {
                btn.addEventListener('click', e => {
                    const { qrText, qrTitle } = e.currentTarget.dataset;
                    showQrModal(qrText, qrTitle);
                });
            });
            window.addEventListener('resize', checkTabsOverflow);
            checkTabsOverflow();
        }

        function attachAppCardListeners(root) {
            root.querySelectorAll?.('.app-card').forEach(card => {
                card.addEventListener('click', e => {
                    const appId = e.currentTarget.dataset.appId;
                    const app = appsConfig.platforms[currentPlatform]?.find(a => a.id === appId);
                    if (app) showAppSetupModal(app);
                });
            });
        }

        function attachSpoilerListeners(root) {
            root.querySelectorAll?.('.spoiler-header').forEach(header => {
                header.addEventListener('click', e => {
                    const content = e.currentTarget.nextElementSibling;
                    content.classList.toggle('open');
                });
            });
        }

        function checkTabsOverflow() {
            const tabs = document.querySelector('.platform-tabs');
            const button = document.getElementById('platform-selector-btn');
            if (!tabs || !button) return;
            if (window.matchMedia('(max-width: 768px)').matches) {
                tabs.style.display = 'none';
                button.style.display = 'inline-flex';
                return;
            }
            const isOverflowing = tabs.scrollWidth > tabs.parentElement.clientWidth;
            if (isOverflowing) {
                tabs.style.display = 'none';
                button.style.display = 'inline-flex';
            } else {
                tabs.style.display = 'flex';
                button.style.display = 'none';
            }
        }
        function showAppSetupModal(app) {
            if (!app) return;
            const titleEl = document.getElementById('appModalTitle');
            titleEl.innerHTML = `<div class="app-icon">${getAppIcon(app, currentPlatform)}</div><span>${escapeHtml(app.name)}</span>`;
            const modalBody = document.getElementById('appModalBody');
            modalBody.innerHTML = renderAppSteps(app);
            updateTexts();
            openModal('appModal');
        }

        function showQrModal(data, title) {
            if (!data) return;
            document.getElementById('qrModalTitle').textContent = title || t('qr_code');
            const qrContainer = document.getElementById('qrCode');
            qrContainer.innerHTML = '';
            try {
                const qr = qrcode(0, 'M');
                qr.addData(data);
                qr.make();
                qrContainer.innerHTML = qr.createImgTag(5, 10);
            } catch (error) {
                console.error('QR generation failed:', error);
                qrContainer.textContent = 'Error generating QR code.';
            }
            openModal('qrModal');
        }

        function showSubscriptionModal() {
            const url = panelData?.response?.subscriptionUrl;
            if (!url) return;
            const qrContainer = document.getElementById('subscriptionQrCode');
            qrContainer.innerHTML = '';
            try {
                const qr = qrcode(0, 'M');
                qr.addData(url);
                qr.make();
                qrContainer.innerHTML = qr.createImgTag(5, 10);
            } catch (error) {
                console.error('QR generation failed:', error);
                qrContainer.textContent = 'Error generating QR code.';
            }
            openModal('subscriptionModal');
        }

        function copySubscriptionUrl() {
            copyToClipboard(panelData?.response?.subscriptionUrl);
        }

        function copyToClipboard(text) {
            if (!text) {
                console.error('Attempted to copy empty text.');
                return;
            }
            navigator.clipboard.writeText(text)
                .then(() => showToast(t('copied')))
                .catch(err => console.error('Could not copy text: ', err));
        }

        function showToast(message) {
            if (toastTimeout) clearTimeout(toastTimeout);
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.classList.add('show');
            toastTimeout = setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        function openModal(id) {
            document.getElementById(id)?.classList.add('active');
        }

        function closeModal(id) {
            document.getElementById(id)?.classList.remove('active');
        }

        function extractLinkName(link) {
            try {
                const url = new URL(link);
                if (url.hash) {
                    return decodeURIComponent(url.hash.substring(1));
                }
            } catch (_) {}
            const idx = link.indexOf('#');
            if (idx !== -1) {
                try {
                    return decodeURIComponent(link.substring(idx + 1));
                } catch (_) {}
                return link.substring(idx + 1);
            }
            return 'Server Link';
        }

        function formatDate(date) {
            if (!date) return '';
            try {
                const locale = currentLanguage === 'ru' ? 'ru-RU' : currentLanguage === 'fa' ? 'fa-IR' : 'en-GB';
                return new Intl.DateTimeFormat(locale, { year: 'numeric', month: 'short', day: 'numeric' }).format(date);
            } catch (error) {
                console.error('Error formatting date:', error);
                return date.toISOString().split('T')[0];
            }
        }

        function escapeHtml(text) {
            if (text === undefined || text === null) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function escapeAttribute(text) {
            if (typeof text !== 'string') return '';
            return text.replace(/"/g, '&quot;').replace(/'/g, '&#39;');
        }

        document.addEventListener('click', e => {
            if (e.target.classList.contains('modal')) {
                e.target.classList.remove('active');
            }
        });

        document.addEventListener('keydown', e => {
            if (e.key === 'Escape') {
                document.querySelectorAll('.modal.active').forEach(m => m.classList.remove('active'));
            }
        });

        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', () => {
            if (localStorage.getItem('theme') === 'auto') {
                applyTheme('auto');
            }
        });
    </script>
</body>
</html>
